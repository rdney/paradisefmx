{% extends "base.html" %}
{% load i18n mention_tags user_tags %}

{% block title %}#{{ request.id }} {{ request.title }} - Paradise FMX{% endblock %}

{% block content %}
<div class="mb-4 no-print">
    <a href="{% url 'requests:list' %}" class="btn btn-outline-secondary btn-lg">
        <i class="bi bi-arrow-left"></i> {% trans "Terug" %}
    </a>
    <button onclick="window.print()" class="btn btn-outline-secondary btn-lg">
        <i class="bi bi-printer"></i> {% trans "Afdrukken" %}
    </button>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Main info -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h3 mb-1">
                        <span class="text-muted">#{{ request.id }}</span>
                        {{ request.title }}
                    </h1>
                    <span class="badge badge-{{ request.status }} me-2">{{ request.get_status_display }}</span>
                    <span class="badge badge-{{ request.priority }}">{{ request.get_priority_display }}</span>
                    {% if request.is_overdue %}
                        <span class="badge bg-danger">{% trans "Te laat" %}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <h2 class="h5">{% trans "Omschrijving" %}</h2>
                <div class="mb-4">
                    {% if triage_form %}
                    <!-- Inline editable description for staff -->
                    <div id="description-display" class="editable-field" onclick="showDescriptionEdit()">
                        {{ request.description|linebreaks }}
                        <small class="text-muted d-block mt-1"><i class="bi bi-pencil"></i> {% trans "Klik om te bewerken" %}</small>
                    </div>
                    <div id="description-edit" style="display: none;">
                        <form method="post" action="{% url 'requests:update_description' request.pk %}" data-no-warn>
                            {% csrf_token %}
                            <textarea name="description" class="form-control form-control-lg mb-2" rows="4">{{ request.description }}</textarea>
                            <button type="submit" class="btn btn-primary">{% trans "Opslaan" %}</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="hideDescriptionEdit()">{% trans "Annuleren" %}</button>
                        </form>
                    </div>
                    {% else %}
                    {{ request.description|linebreaks }}
                    {% endif %}
                </div>

                <h2 class="h5">{% trans "Oplossing" %}</h2>
                <div class="mb-4">
                    {% if triage_form %}
                    <!-- Inline editable resolution for staff -->
                    <div id="resolution-display" class="editable-field" onclick="showResolutionEdit()">
                        {% if request.resolution_summary %}
                            {{ request.resolution_summary|linebreaks }}
                        {% else %}
                            <span class="text-muted">{% trans "Nog niet ingevuld" %}</span>
                        {% endif %}
                        <small class="text-muted d-block mt-1"><i class="bi bi-pencil"></i> {% trans "Klik om te bewerken" %}</small>
                    </div>
                    <div id="resolution-edit" style="display: none;">
                        <form method="post" action="{% url 'requests:update_resolution' request.pk %}" data-no-warn>
                            {% csrf_token %}
                            <textarea name="resolution_summary" class="form-control form-control-lg mb-2" rows="3" placeholder="{% trans 'Beschrijf hoe het probleem is opgelost...' %}">{{ request.resolution_summary }}</textarea>
                            <button type="submit" class="btn btn-primary">{% trans "Opslaan" %}</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="hideResolutionEdit()">{% trans "Annuleren" %}</button>
                        </form>
                    </div>
                    {% else %}
                        {% if request.resolution_summary %}
                            {{ request.resolution_summary|linebreaks }}
                        {% else %}
                            <span class="text-muted">{% trans "Nog niet ingevuld" %}</span>
                        {% endif %}
                    {% endif %}
                </div>

                <dl class="row mb-0">
                    <dt class="col-sm-4">{% trans "Locatie" %}</dt>
                    <dd class="col-sm-8">{{ request.location|default:"-" }}</dd>

                    {% if request.asset %}
                        <dt class="col-sm-4">{% trans "Object" %}</dt>
                        <dd class="col-sm-8">
                            <a href="{% url 'assets:detail' request.asset.pk %}">{{ request.asset }}</a>
                        </dd>
                    {% endif %}

                    <dt class="col-sm-4">{% trans "Melder" %}</dt>
                    <dd class="col-sm-8">{{ request.requester_name }}</dd>

                    {% if request.assigned_to %}
                        <dt class="col-sm-4">{% trans "Toegewezen aan" %}</dt>
                        <dd class="col-sm-8">{{ request.assigned_to|user_display }}</dd>
                    {% endif %}

                    {% if request.due_date %}
                        <dt class="col-sm-4">{% trans "Streefdatum" %}</dt>
                        <dd class="col-sm-8">
                            {{ request.due_date }}
                            {% if request.is_overdue %}
                                <span class="badge bg-danger">{% trans "Te laat" %}</span>
                            {% endif %}
                        </dd>
                    {% endif %}

                    {% if request.estimated_cost %}
                        <dt class="col-sm-4">{% trans "Geschatte kosten" %}</dt>
                        <dd class="col-sm-8">€ {{ request.estimated_cost }}</dd>
                    {% endif %}

                    {% if request.actual_cost %}
                        <dt class="col-sm-4">{% trans "Werkelijke kosten" %}</dt>
                        <dd class="col-sm-8">€ {{ request.actual_cost }}</dd>
                    {% endif %}

                    {% if request.vendor or request.quote_status != 'none' %}
                        <dt class="col-sm-4 mt-3 border-top pt-3">{% trans "Inkoop" %}</dt>
                        <dd class="col-sm-8 mt-3 border-top pt-3"></dd>

                        {% if request.vendor %}
                            <dt class="col-sm-4">{% trans "Leverancier" %}</dt>
                            <dd class="col-sm-8">{{ request.vendor }}</dd>
                        {% endif %}

                        {% if request.quote_status != 'none' %}
                            <dt class="col-sm-4">{% trans "Offertestatus" %}</dt>
                            <dd class="col-sm-8">
                                <span class="badge badge-quote-{{ request.quote_status }}">{{ request.get_quote_status_display }}</span>
                            </dd>
                        {% endif %}

                        {% if request.quote_amount %}
                            <dt class="col-sm-4">{% trans "Offertebedrag" %}</dt>
                            <dd class="col-sm-8">€ {{ request.quote_amount }}</dd>
                        {% endif %}

                        {% if request.po_number %}
                            <dt class="col-sm-4">{% trans "PO-nummer" %}</dt>
                            <dd class="col-sm-8">{{ request.po_number }}</dd>
                        {% endif %}
                    {% endif %}

                    <dt class="col-sm-4">{% trans "Ingediend" %}</dt>
                    <dd class="col-sm-8">{{ request.created_at|date:"d-m-Y H:i" }}</dd>
                </dl>
            </div>
        </div>

        <!-- Attachments -->
        {% if attachments %}
            <div class="card mb-4" id="bijlagen">
                <div class="card-header">
                    <h2 class="h4 mb-0">{% trans "Bijlagen" %}</h2>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for attachment in attachments %}
                            <div class="col-6 col-md-3">
                                <div class="attachment-card text-center">
                                    {% if attachment.is_image %}
                                        <a href="{{ attachment.secure_url }}" target="_blank" class="d-block">
                                            <img src="{{ attachment.thumbnail_url }}" class="img-thumbnail" alt="{{ attachment.display_name }}" style="width: 100%; height: 120px; object-fit: cover;">
                                        </a>
                                    {% else %}
                                        <a href="{{ attachment.secure_url }}" class="d-block p-3 border rounded text-decoration-none d-flex align-items-center justify-content-center" target="_blank" style="height: 120px;">
                                            <i class="bi {{ attachment.file_icon }} {{ attachment.icon_color }}" style="font-size: 3rem;"></i>
                                        </a>
                                    {% endif %}
                                    <div class="mt-2">
                                        <small class="d-block text-truncate" title="{{ attachment.display_name }}">
                                            {{ attachment.display_name }}
                                        </small>
                                        <form method="post" action="{% url 'requests:delete_attachment' request.pk attachment.pk %}" class="d-inline no-print" onsubmit="return confirm('{% trans 'Weet u zeker dat u deze bijlage wilt verwijderen?' %}');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-link btn-sm text-danger p-0" title="{% trans 'Verwijderen' %}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Work log / Timeline -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">{% trans "Logboek" %}</h2>
            </div>
            <div class="card-body">
                {% if work_logs %}
                    <div class="timeline">
                        {% for log in work_logs %}
                            <div class="timeline-item {{ log.entry_type }}">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <div>
                                        <strong>
                                            {% if log.author %}
                                                {{ log.author|user_display }}
                                            {% else %}
                                                {% trans "Systeem" %}
                                            {% endif %}
                                        </strong>
                                        <span class="badge {% if log.entry_type == 'created' %}bg-success{% elif log.entry_type == 'status_change' %}bg-primary{% elif log.entry_type == 'assignment' %}bg-info{% elif log.entry_type == 'time_spent' %}bg-secondary{% else %}bg-light text-dark{% endif %} ms-2">
                                            {{ log.get_entry_type_display }}
                                        </span>
                                    </div>
                                    <small class="text-muted">{{ log.created_at|date:"d-m-Y H:i" }}</small>
                                </div>
                                <p class="mb-1">{{ log.note|highlight_mentions|safe }}</p>
                                {% if log.minutes_spent %}
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i>
                                        {{ log.minutes_spent }} {% trans "minuten" %}
                                    </small>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted mb-0">{% trans "Nog geen logboekregels." %}</p>
                {% endif %}
            </div>
        </div>

        <!-- Add note form -->
        <div class="card no-print">
            <div class="card-header">
                <h2 class="h4 mb-0">{% trans "Notitie toevoegen" %}</h2>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'requests:add_worklog' request.pk %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ worklog_form.note }}
                    </div>
                    <div class="row align-items-end">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label class="form-label" for="id_minutes_spent">{% trans "Tijd besteed (minuten)" %}</label>
                            {{ worklog_form.minutes_spent }}
                        </div>
                        <div class="col-md-8 text-end">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-plus-circle"></i> {% trans "Toevoegen" %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Triage form (staff only) -->
        {% if triage_form %}
            <div class="card mb-4 no-print">
                <div class="card-header">
                    <h2 class="h4 mb-0">{% trans "Bewerken" %}</h2>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'requests:update' request.pk %}">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label class="form-label" for="id_location">{% trans "Locatie" %}</label>
                            {{ triage_form.location }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_asset">{% trans "Object" %}</label>
                            {{ triage_form.asset }}
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label" for="id_status">{% trans "Status" %}</label>
                            {{ triage_form.status }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_priority">{% trans "Prioriteit" %}</label>
                            {{ triage_form.priority }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_assigned_to">{% trans "Toewijzen aan" %}</label>
                            {{ triage_form.assigned_to }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_due_date">{% trans "Streefdatum" %}</label>
                            {{ triage_form.due_date }}
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label" for="id_estimated_cost">{% trans "Geschatte kosten (€)" %}</label>
                            {{ triage_form.estimated_cost }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_actual_cost">{% trans "Werkelijke kosten (€)" %}</label>
                            {{ triage_form.actual_cost }}
                        </div>

                        <hr>
                        <div class="mb-3">
                            <a class="text-decoration-none d-flex align-items-center justify-content-between" data-bs-toggle="collapse" href="#inkoopSection" role="button" aria-expanded="{% if request.vendor or request.quote_status != 'none' or request.po_number %}true{% else %}false{% endif %}">
                                <span class="h5 mb-0">{% trans "Vergt inkoop/aannemer" %}</span>
                                <i class="bi bi-chevron-down"></i>
                            </a>
                        </div>
                        <div class="collapse {% if request.vendor or request.quote_status != 'none' or request.po_number %}show{% endif %}" id="inkoopSection">
                            <div class="mb-3">
                                <label class="form-label" for="id_vendor">{% trans "Leverancier" %}</label>
                                {{ triage_form.vendor }}
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="id_quote_status">{% trans "Offertestatus" %}</label>
                                    {{ triage_form.quote_status }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="id_quote_amount">{% trans "Offertebedrag (€)" %}</label>
                                    {{ triage_form.quote_amount }}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" for="id_po_number">{% trans "PO-nummer" %}</label>
                                {{ triage_form.po_number }}
                            </div>
                        </div>

                        <hr>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle"></i> {% trans "Opslaan" %}
                            </button>
                        </div>
                    </form>
                    <hr>
                    <a href="{% url 'requests:duplicate' request.pk %}" class="btn btn-outline-secondary btn-lg w-100 mb-2">
                        <i class="bi bi-copy"></i> {% trans "Dupliceren" %}
                    </a>
                    <a href="{% url 'requests:delete' request.pk %}" class="btn btn-outline-danger btn-lg w-100">
                        <i class="bi bi-trash"></i> {% trans "Verwijderen" %}
                    </a>
                </div>
            </div>
        {% endif %}

        <!-- Upload attachment -->
        <div class="card no-print" id="upload">
            <div class="card-header">
                <h2 class="h4 mb-0">{% trans "Bijlage uploaden" %}</h2>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'requests:add_attachment' request.pk %}" enctype="multipart/form-data" id="attachment_form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label" for="id_title">{% trans "Titel" %}</label>
                        {{ attachment_form.title }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="id_file">{% trans "Bestand" %}</label>
                        {{ attachment_form.file }}
                    </div>
                    <div class="d-grid">
                        <button type="submit" id="attachment_submit_btn" class="btn btn-outline-primary btn-lg">
                            <span id="attachment_btn_icon"><i class="bi bi-upload"></i></span>
                            <span id="attachment_btn_text">{% trans "Uploaden" %}</span>
                        </button>
                    </div>
                </form>
                <small class="text-muted d-block mt-2">
                    {% trans "Toegestaan: afbeeldingen en PDF (max 10MB)" %}
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .mention-dropdown {
        position: absolute;
        left: 0;
        top: 100%;
        margin-top: 4px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        max-height: 200px;
        min-width: 200px;
        overflow-y: auto;
        z-index: 1050;
        display: none;
    }
    .mention-dropdown.show { display: block; }
    .mention-dropdown.above { top: auto; bottom: 100%; margin-top: 0; margin-bottom: 4px; }
    .mention-dropdown.below { bottom: auto; top: 100%; margin-bottom: 0; margin-top: 4px; }
    .mention-item {
        padding: 10px 14px;
        cursor: pointer;
        font-size: 1rem;
    }
    .mention-item:hover, .mention-item.active {
        background: #e9ecef;
    }
    .mention-item strong { color: #0d6efd; }
    .editable-field {
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    .editable-field:hover {
        background-color: #f8f9fa;
    }
    [data-bs-toggle="collapse"] .bi-chevron-down {
        transition: transform 0.2s;
    }
    [data-bs-toggle="collapse"][aria-expanded="true"] .bi-chevron-down {
        transform: rotate(180deg);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const textarea = document.querySelector('textarea[name="note"]');
    if (!textarea) return;

    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'mention-dropdown';
    textarea.parentNode.style.position = 'relative';
    textarea.parentNode.appendChild(dropdown);

    let mentionStart = -1;
    let activeIndex = 0;
    let debounceTimer = null;

    textarea.addEventListener('input', function(e) {
        const text = this.value;
        const cursor = this.selectionStart;

        // Find @ before cursor
        const beforeCursor = text.slice(0, cursor);
        const atIndex = beforeCursor.lastIndexOf('@');

        if (atIndex >= 0) {
            const afterAt = beforeCursor.slice(atIndex + 1);
            // Check if we're in a mention (no space after @)
            if (!/\s/.test(afterAt)) {
                mentionStart = atIndex;
                // Debounce API calls
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => searchUsers(afterAt), 150);
                return;
            }
        }
        hideDropdown();
    });

    textarea.addEventListener('keydown', function(e) {
        if (!dropdown.classList.contains('show')) return;

        const items = dropdown.querySelectorAll('.mention-item');
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIndex = Math.min(activeIndex + 1, items.length - 1);
            updateActive(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIndex = Math.max(activeIndex - 1, 0);
            updateActive(items);
        } else if (e.key === 'Enter' || e.key === 'Tab') {
            if (items.length > 0) {
                e.preventDefault();
                selectUser(items[activeIndex].dataset.username);
            }
        } else if (e.key === 'Escape') {
            hideDropdown();
        }
    });

    function searchUsers(query) {
        fetch(`{% url 'requests:user_search' %}?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(data => {
                if (data.users.length === 0) {
                    hideDropdown();
                    return;
                }
                activeIndex = 0;
                dropdown.innerHTML = data.users.map((u, i) =>
                    `<div class="mention-item ${i === 0 ? 'active' : ''}" data-username="${u.username}">
                        <strong>@${u.username}</strong> ${u.name !== u.username ? '- ' + u.name : ''}
                    </div>`
                ).join('');

                dropdown.querySelectorAll('.mention-item').forEach(item => {
                    item.addEventListener('click', () => selectUser(item.dataset.username));
                });

                // Position above or below based on available space
                const rect = textarea.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.bottom;
                dropdown.classList.remove('above', 'below');
                dropdown.classList.add(spaceBelow < 250 ? 'above' : 'below');

                dropdown.classList.add('show');
            });
    }

    function selectUser(username) {
        const text = textarea.value;
        const before = text.slice(0, mentionStart);
        const after = text.slice(textarea.selectionStart);
        textarea.value = before + '@' + username + ' ' + after;
        textarea.focus({ preventScroll: true });
        const newPos = mentionStart + username.length + 2;
        textarea.setSelectionRange(newPos, newPos);
        hideDropdown();
    }

    function hideDropdown() {
        dropdown.classList.remove('show');
        mentionStart = -1;
    }

    function updateActive(items) {
        items.forEach((item, i) => {
            item.classList.toggle('active', i === activeIndex);
        });
    }
})();

// Inline description editing
function showDescriptionEdit() {
    document.getElementById('description-display').style.display = 'none';
    document.getElementById('description-edit').style.display = 'block';
    document.querySelector('#description-edit textarea').focus({ preventScroll: true });
}

function hideDescriptionEdit() {
    document.getElementById('description-display').style.display = 'block';
    document.getElementById('description-edit').style.display = 'none';
}

// Inline resolution editing
function showResolutionEdit() {
    document.getElementById('resolution-display').style.display = 'none';
    document.getElementById('resolution-edit').style.display = 'block';
    document.querySelector('#resolution-edit textarea').focus({ preventScroll: true });
}

function hideResolutionEdit() {
    document.getElementById('resolution-display').style.display = 'block';
    document.getElementById('resolution-edit').style.display = 'none';
}

// Attachment upload with progress
(function() {
    const form = document.getElementById('attachment_form');
    if (!form) return;

    const submitBtn = document.getElementById('attachment_submit_btn');
    const btnIcon = document.getElementById('attachment_btn_icon');
    const btnText = document.getElementById('attachment_btn_text');
    const fileInput = form.querySelector('input[type="file"]');

    form.addEventListener('submit', function(e) {
        if (!fileInput.files.length) return;

        e.preventDefault();

        // Blur to prevent scroll when disabling
        submitBtn.blur();

        const formData = new FormData(form);

        // Show spinner in button
        submitBtn.disabled = true;
        btnIcon.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btnText.textContent = ' 0%';

        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', function(evt) {
            if (evt.lengthComputable) {
                const percent = Math.round((evt.loaded / evt.total) * 100);
                btnText.textContent = ' ' + percent + '%';
            }
        });

        xhr.addEventListener('load', function() {
            if (xhr.status >= 200 && xhr.status < 400) {
                btnIcon.innerHTML = '<i class="bi bi-check-lg"></i>';
                btnText.textContent = ' {% trans "Voltooid!" %}';
                setTimeout(function() {
                    window.location.hash = 'bijlagen';
                    window.location.reload();
                }, 500);
            } else {
                resetBtn();
                alert('{% trans "Er is iets misgegaan. Probeer het opnieuw." %}');
            }
        });

        xhr.addEventListener('error', function() {
            resetBtn();
            alert('{% trans "Er is iets misgegaan. Probeer het opnieuw." %}');
        });

        function resetBtn() {
            submitBtn.disabled = false;
            btnIcon.innerHTML = '<i class="bi bi-upload"></i>';
            btnText.textContent = ' {% trans "Uploaden" %}';
        }

        xhr.open('POST', form.action);
        xhr.send(formData);
    });
})();
</script>
{% endblock %}
