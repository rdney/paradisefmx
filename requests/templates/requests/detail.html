{% extends "base.html" %}
{% load i18n mention_tags %}

{% block title %}#{{ request.id }} {{ request.title }} - Paradise FMX{% endblock %}

{% block content %}
<div class="mb-4 no-print">
    <a href="{% url 'requests:list' %}" class="btn btn-outline-secondary btn-lg">
        <i class="bi bi-arrow-left"></i> {% trans "Terug" %}
    </a>
    <button onclick="window.print()" class="btn btn-outline-secondary btn-lg">
        <i class="bi bi-printer"></i> {% trans "Afdrukken" %}
    </button>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Main info -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h3 mb-1">
                        <span class="text-muted">#{{ request.id }}</span>
                        {{ request.title }}
                    </h1>
                    <span class="badge badge-{{ request.status }} me-2">{{ request.get_status_display }}</span>
                    <span class="badge badge-{{ request.priority }}">{{ request.get_priority_display }}</span>
                    {% if request.is_overdue %}
                        <span class="badge bg-danger">{% trans "Te laat" %}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <h2 class="h5">{% trans "Omschrijving" %}</h2>
                <div class="mb-4">
                    {{ request.description|linebreaks }}
                </div>

                <dl class="row mb-0">
                    <dt class="col-sm-4">{% trans "Locatie" %}</dt>
                    <dd class="col-sm-8">{{ request.location|default:"-" }}</dd>

                    {% if request.asset %}
                        <dt class="col-sm-4">{% trans "Object" %}</dt>
                        <dd class="col-sm-8">
                            <a href="{% url 'assets:detail' request.asset.pk %}">{{ request.asset }}</a>
                        </dd>
                    {% endif %}

                    <dt class="col-sm-4">{% trans "Melder" %}</dt>
                    <dd class="col-sm-8">{{ request.requester_name }}</dd>

                    {% if request.assigned_to %}
                        <dt class="col-sm-4">{% trans "Toegewezen aan" %}</dt>
                        <dd class="col-sm-8">{{ request.assigned_to.get_full_name|default:request.assigned_to.username }}</dd>
                    {% endif %}

                    {% if request.due_date %}
                        <dt class="col-sm-4">{% trans "Streefdatum" %}</dt>
                        <dd class="col-sm-8">
                            {{ request.due_date }}
                            {% if request.is_overdue %}
                                <span class="badge bg-danger">{% trans "Te laat" %}</span>
                            {% endif %}
                        </dd>
                    {% endif %}

                    {% if request.estimated_cost %}
                        <dt class="col-sm-4">{% trans "Geschatte kosten" %}</dt>
                        <dd class="col-sm-8">€ {{ request.estimated_cost }}</dd>
                    {% endif %}

                    {% if request.actual_cost %}
                        <dt class="col-sm-4">{% trans "Werkelijke kosten" %}</dt>
                        <dd class="col-sm-8">€ {{ request.actual_cost }}</dd>
                    {% endif %}

                    {% if request.vendor or request.quote_status != 'none' %}
                        <dt class="col-sm-4 mt-3 border-top pt-3">{% trans "Inkoop" %}</dt>
                        <dd class="col-sm-8 mt-3 border-top pt-3"></dd>

                        {% if request.vendor %}
                            <dt class="col-sm-4">{% trans "Leverancier" %}</dt>
                            <dd class="col-sm-8">{{ request.vendor }}</dd>
                        {% endif %}

                        {% if request.quote_status != 'none' %}
                            <dt class="col-sm-4">{% trans "Offertestatus" %}</dt>
                            <dd class="col-sm-8">
                                <span class="badge badge-quote-{{ request.quote_status }}">{{ request.get_quote_status_display }}</span>
                            </dd>
                        {% endif %}

                        {% if request.quote_amount %}
                            <dt class="col-sm-4">{% trans "Offertebedrag" %}</dt>
                            <dd class="col-sm-8">€ {{ request.quote_amount }}</dd>
                        {% endif %}

                        {% if request.po_number %}
                            <dt class="col-sm-4">{% trans "PO-nummer" %}</dt>
                            <dd class="col-sm-8">{{ request.po_number }}</dd>
                        {% endif %}
                    {% endif %}

                    <dt class="col-sm-4">{% trans "Ingediend" %}</dt>
                    <dd class="col-sm-8">{{ request.created_at|date:"d-m-Y H:i" }}</dd>

                    {% if request.resolution_summary %}
                        <dt class="col-sm-4">{% trans "Oplossing" %}</dt>
                        <dd class="col-sm-8">{{ request.resolution_summary|linebreaks }}</dd>
                    {% endif %}
                </dl>
            </div>
        </div>

        <!-- Attachments -->
        {% if attachments %}
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h4 mb-0">{% trans "Bijlagen" %}</h2>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for attachment in attachments %}
                            <div class="col-md-4">
                                {% if attachment.is_image %}
                                    <a href="{{ attachment.file.url }}" target="_blank">
                                        <img src="{{ attachment.file.url }}" class="img-thumbnail" alt="{{ attachment.filename }}">
                                    </a>
                                {% else %}
                                    <a href="{{ attachment.file.url }}" class="btn btn-outline-secondary w-100" target="_blank">
                                        <i class="bi bi-file-pdf"></i> {{ attachment.filename }}
                                    </a>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Work log / Timeline -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">{% trans "Logboek" %}</h2>
            </div>
            <div class="card-body">
                {% if work_logs %}
                    <div class="timeline">
                        {% for log in work_logs %}
                            <div class="timeline-item {{ log.entry_type }}">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <div>
                                        <strong>
                                            {% if log.author %}
                                                {{ log.author.get_full_name|default:log.author.username }}
                                            {% else %}
                                                {% trans "Systeem" %}
                                            {% endif %}
                                        </strong>
                                        <span class="badge {% if log.entry_type == 'created' %}bg-success{% elif log.entry_type == 'status_change' %}bg-primary{% elif log.entry_type == 'assignment' %}bg-info{% elif log.entry_type == 'time_spent' %}bg-secondary{% else %}bg-light text-dark{% endif %} ms-2">
                                            {{ log.get_entry_type_display }}
                                        </span>
                                    </div>
                                    <small class="text-muted">{{ log.created_at|date:"d-m-Y H:i" }}</small>
                                </div>
                                <p class="mb-1">{{ log.note|highlight_mentions|safe }}</p>
                                {% if log.minutes_spent %}
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i>
                                        {{ log.minutes_spent }} {% trans "minuten" %}
                                    </small>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted mb-0">{% trans "Nog geen logboekregels." %}</p>
                {% endif %}
            </div>
        </div>

        <!-- Add note form -->
        <div class="card no-print">
            <div class="card-header">
                <h2 class="h4 mb-0">{% trans "Notitie toevoegen" %}</h2>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'requests:add_worklog' request.pk %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ worklog_form.note }}
                    </div>
                    <div class="row align-items-end">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label class="form-label" for="id_minutes_spent">{% trans "Tijd besteed (minuten)" %}</label>
                            {{ worklog_form.minutes_spent }}
                        </div>
                        <div class="col-md-8 text-end">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-plus-circle"></i> {% trans "Toevoegen" %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Triage form (staff only) -->
        {% if triage_form %}
            <div class="card mb-4 no-print">
                <div class="card-header">
                    <h2 class="h4 mb-0">{% trans "Bewerken" %}</h2>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'requests:update' request.pk %}">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label class="form-label" for="id_status">{% trans "Status" %}</label>
                            {{ triage_form.status }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_priority">{% trans "Prioriteit" %}</label>
                            {{ triage_form.priority }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_assigned_to">{% trans "Toewijzen aan" %}</label>
                            {{ triage_form.assigned_to }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_due_date">{% trans "Streefdatum" %}</label>
                            {{ triage_form.due_date }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_estimated_cost">{% trans "Geschatte kosten (€)" %}</label>
                            {{ triage_form.estimated_cost }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_actual_cost">{% trans "Werkelijke kosten (€)" %}</label>
                            {{ triage_form.actual_cost }}
                        </div>

                        <hr>
                        <h3 class="h5 mb-3">{% trans "Inkoop" %}</h3>

                        <div class="mb-3">
                            <label class="form-label" for="id_vendor">{% trans "Leverancier" %}</label>
                            {{ triage_form.vendor }}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="id_quote_status">{% trans "Offertestatus" %}</label>
                                {{ triage_form.quote_status }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label" for="id_quote_amount">{% trans "Offertebedrag (€)" %}</label>
                                {{ triage_form.quote_amount }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="id_po_number">{% trans "PO-nummer" %}</label>
                            {{ triage_form.po_number }}
                        </div>

                        <hr>
                        <div class="mb-3">
                            <label class="form-label" for="id_resolution_summary">{% trans "Oplossing" %}</label>
                            {{ triage_form.resolution_summary }}
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle"></i> {% trans "Opslaan" %}
                            </button>
                        </div>
                    </form>
                    <hr>
                    <a href="{% url 'requests:delete' request.pk %}" class="btn btn-outline-danger btn-lg w-100">
                        <i class="bi bi-trash"></i> {% trans "Verwijderen" %}
                    </a>
                </div>
            </div>
        {% endif %}

        <!-- Upload attachment -->
        <div class="card no-print">
            <div class="card-header">
                <h2 class="h4 mb-0">{% trans "Bijlage uploaden" %}</h2>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'requests:add_attachment' request.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ attachment_form.file }}
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-outline-primary btn-lg">
                            <i class="bi bi-upload"></i> {% trans "Uploaden" %}
                        </button>
                    </div>
                </form>
                <small class="text-muted d-block mt-2">
                    {% trans "Toegestaan: afbeeldingen en PDF (max 10MB)" %}
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .mention-dropdown {
        position: absolute;
        left: 0;
        top: 100%;
        margin-top: 4px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        max-height: 200px;
        min-width: 200px;
        overflow-y: auto;
        z-index: 1050;
        display: none;
    }
    .mention-dropdown.show { display: block; }
    .mention-dropdown.above { top: auto; bottom: 100%; margin-top: 0; margin-bottom: 4px; }
    .mention-dropdown.below { bottom: auto; top: 100%; margin-bottom: 0; margin-top: 4px; }
    .mention-item {
        padding: 10px 14px;
        cursor: pointer;
        font-size: 1rem;
    }
    .mention-item:hover, .mention-item.active {
        background: #e9ecef;
    }
    .mention-item strong { color: #0d6efd; }
</style>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const textarea = document.querySelector('textarea[name="note"]');
    if (!textarea) return;

    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'mention-dropdown';
    textarea.parentNode.style.position = 'relative';
    textarea.parentNode.appendChild(dropdown);

    let mentionStart = -1;
    let activeIndex = 0;

    textarea.addEventListener('input', function(e) {
        const text = this.value;
        const cursor = this.selectionStart;

        // Find @ before cursor
        const beforeCursor = text.slice(0, cursor);
        const atIndex = beforeCursor.lastIndexOf('@');

        if (atIndex >= 0) {
            const afterAt = beforeCursor.slice(atIndex + 1);
            // Check if we're in a mention (no space after @)
            if (!/\s/.test(afterAt)) {
                mentionStart = atIndex;
                searchUsers(afterAt);
                return;
            }
        }
        hideDropdown();
    });

    textarea.addEventListener('keydown', function(e) {
        if (!dropdown.classList.contains('show')) return;

        const items = dropdown.querySelectorAll('.mention-item');
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIndex = Math.min(activeIndex + 1, items.length - 1);
            updateActive(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIndex = Math.max(activeIndex - 1, 0);
            updateActive(items);
        } else if (e.key === 'Enter' || e.key === 'Tab') {
            if (items.length > 0) {
                e.preventDefault();
                selectUser(items[activeIndex].dataset.username);
            }
        } else if (e.key === 'Escape') {
            hideDropdown();
        }
    });

    function searchUsers(query) {
        fetch(`{% url 'requests:user_search' %}?q=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(data => {
                if (data.users.length === 0) {
                    hideDropdown();
                    return;
                }
                activeIndex = 0;
                dropdown.innerHTML = data.users.map((u, i) =>
                    `<div class="mention-item ${i === 0 ? 'active' : ''}" data-username="${u.username}">
                        <strong>@${u.username}</strong> ${u.name !== u.username ? '- ' + u.name : ''}
                    </div>`
                ).join('');

                dropdown.querySelectorAll('.mention-item').forEach(item => {
                    item.addEventListener('click', () => selectUser(item.dataset.username));
                });

                // Position above or below based on available space
                const rect = textarea.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.bottom;
                dropdown.classList.remove('above', 'below');
                dropdown.classList.add(spaceBelow < 250 ? 'above' : 'below');

                dropdown.classList.add('show');
            });
    }

    function selectUser(username) {
        const text = textarea.value;
        const before = text.slice(0, mentionStart);
        const after = text.slice(textarea.selectionStart);
        textarea.value = before + '@' + username + ' ' + after;
        textarea.focus();
        const newPos = mentionStart + username.length + 2;
        textarea.setSelectionRange(newPos, newPos);
        hideDropdown();
    }

    function hideDropdown() {
        dropdown.classList.remove('show');
        mentionStart = -1;
    }

    function updateActive(items) {
        items.forEach((item, i) => {
            item.classList.toggle('active', i === activeIndex);
        });
    }
})();
</script>
{% endblock %}
